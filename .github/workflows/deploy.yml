name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_migrations:
        description: "Run database migrations"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      deploy_frontend:
        description: "Deploy frontend application"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      deploy_email_service:
        description: "Deploy email service"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      deploy_events_service:
        description: "Deploy events service"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      deploy_image_service:
        description: "Deploy image service"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      deploy_nginx:
        description: "Deploy nginx configuration"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      deploy_postgrest:
        description: "Deploy PostgREST configuration"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

env:
  NODE_VERSION: "22"

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      run_migrations: ${{ steps.changes.outputs.run_migrations }}
      deploy_frontend: ${{ steps.changes.outputs.deploy_frontend }}
      deploy_email_service: ${{ steps.changes.outputs.deploy_email_service }}
      deploy_events_service: ${{ steps.changes.outputs.deploy_events_service }}
      deploy_image_service: ${{ steps.changes.outputs.deploy_image_service }}
      deploy_nginx: ${{ steps.changes.outputs.deploy_nginx }}
      deploy_postgrest: ${{ steps.changes.outputs.deploy_postgrest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          WORKFLOW_SHA=$(git rev-parse HEAD)
          echo "Using HEAD SHA: $WORKFLOW_SHA"

          # For push events, compare against the before SHA (catches multi-commit pushes)
          # For workflow_dispatch, compare against parent commit
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PARENT_SHA="${{ github.event.before }}"
            # Handle initial push (all zeros)
            if [[ "$PARENT_SHA" == "0000000000000000000000000000000000000000" ]]; then
              PARENT_SHA=""
            fi
            echo "Using push before SHA: $PARENT_SHA"
          else
            git fetch origin ${{ github.ref_name }} --depth=100 || echo "Fetching history failed"
            PARENT_SHA=$(git rev-parse $WORKFLOW_SHA^ 2>/dev/null || echo "")
            echo "Using parent SHA: $PARENT_SHA"
          fi

          # Check for migration changes
          if [[ "${{ github.event.inputs.run_migrations }}" == "false" ]]; then
            echo "run_migrations=false" >> $GITHUB_OUTPUT
            echo "Skipping migrations as requested"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.run_migrations }}" == "true" ]]; then
            echo "run_migrations=true" >> $GITHUB_OUTPUT
            echo "Manual request to run migrations"
          elif [[ -z "$PARENT_SHA" ]]; then
            echo "run_migrations=true" >> $GITHUB_OUTPUT
            echo "First commit, running migrations"
          else
            CHANGED_FILES=$(git diff --name-only $PARENT_SHA $WORKFLOW_SHA 2>/dev/null || git ls-files)
            if echo "$CHANGED_FILES" | grep -q "^flyway/"; then
              echo "run_migrations=true" >> $GITHUB_OUTPUT
              echo "Database changes detected"
            else
              echo "run_migrations=false" >> $GITHUB_OUTPUT
              echo "No database changes detected"
            fi
          fi

          # Check for frontend changes
          if [[ "${{ github.event.inputs.deploy_frontend }}" == "false" ]]; then
            echo "deploy_frontend=false" >> $GITHUB_OUTPUT
            echo "Skipping frontend deployment as requested"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.deploy_frontend }}" == "true" ]]; then
            echo "deploy_frontend=true" >> $GITHUB_OUTPUT
            echo "Manual request to deploy frontend"
          elif [[ -z "$PARENT_SHA" ]]; then
            echo "deploy_frontend=true" >> $GITHUB_OUTPUT
            echo "First commit, deploying frontend"
          else
            CHANGED_FILES=$(git diff --name-only $PARENT_SHA $WORKFLOW_SHA 2>/dev/null || git ls-files)
            if echo "$CHANGED_FILES" | grep -qE "^apps/web/|^packages/shared/"; then
              echo "deploy_frontend=true" >> $GITHUB_OUTPUT
              echo "Frontend changes detected"
            else
              echo "deploy_frontend=false" >> $GITHUB_OUTPUT
              echo "No frontend changes detected"
            fi
          fi

          # Check for email-service changes
          if [[ "${{ github.event.inputs.deploy_email_service }}" == "false" ]]; then
            echo "deploy_email_service=false" >> $GITHUB_OUTPUT
            echo "Skipping email-service deployment as requested"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.deploy_email_service }}" == "true" ]]; then
            echo "deploy_email_service=true" >> $GITHUB_OUTPUT
            echo "Manual request to deploy email-service"
          elif [[ -z "$PARENT_SHA" ]]; then
            echo "deploy_email_service=true" >> $GITHUB_OUTPUT
            echo "First commit, deploying email-service"
          else
            CHANGED_FILES=$(git diff --name-only $PARENT_SHA $WORKFLOW_SHA 2>/dev/null || git ls-files)
            if echo "$CHANGED_FILES" | grep -qE "^apps/email-service/|^packages/shared/"; then
              echo "deploy_email_service=true" >> $GITHUB_OUTPUT
              echo "Email-service changes detected"
            else
              echo "deploy_email_service=false" >> $GITHUB_OUTPUT
              echo "No email-service changes detected"
            fi
          fi

          # Check for events-service changes
          if [[ "${{ github.event.inputs.deploy_events_service }}" == "false" ]]; then
            echo "deploy_events_service=false" >> $GITHUB_OUTPUT
            echo "Skipping events-service deployment as requested"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.deploy_events_service }}" == "true" ]]; then
            echo "deploy_events_service=true" >> $GITHUB_OUTPUT
            echo "Manual request to deploy events-service"
          elif [[ -z "$PARENT_SHA" ]]; then
            echo "deploy_events_service=true" >> $GITHUB_OUTPUT
            echo "First commit, deploying events-service"
          else
            CHANGED_FILES=$(git diff --name-only $PARENT_SHA $WORKFLOW_SHA 2>/dev/null || git ls-files)
            if echo "$CHANGED_FILES" | grep -qE "^apps/events-service/|^packages/shared/"; then
              echo "deploy_events_service=true" >> $GITHUB_OUTPUT
              echo "Events-service changes detected"
            else
              echo "deploy_events_service=false" >> $GITHUB_OUTPUT
              echo "No events-service changes detected"
            fi
          fi

          # Check for image-service changes
          if [[ "${{ github.event.inputs.deploy_image_service }}" == "false" ]]; then
            echo "deploy_image_service=false" >> $GITHUB_OUTPUT
            echo "Skipping image-service deployment as requested"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.deploy_image_service }}" == "true" ]]; then
            echo "deploy_image_service=true" >> $GITHUB_OUTPUT
            echo "Manual request to deploy image-service"
          elif [[ -z "$PARENT_SHA" ]]; then
            echo "deploy_image_service=true" >> $GITHUB_OUTPUT
            echo "First commit, deploying image-service"
          else
            CHANGED_FILES=$(git diff --name-only $PARENT_SHA $WORKFLOW_SHA 2>/dev/null || git ls-files)
            if echo "$CHANGED_FILES" | grep -qE "^apps/image-service/|^packages/shared/"; then
              echo "deploy_image_service=true" >> $GITHUB_OUTPUT
              echo "Image-service changes detected"
            else
              echo "deploy_image_service=false" >> $GITHUB_OUTPUT
              echo "No image-service changes detected"
            fi
          fi

          # Check for PostgREST config changes
          if [[ "${{ github.event.inputs.deploy_postgrest }}" == "false" ]]; then
            echo "deploy_postgrest=false" >> $GITHUB_OUTPUT
            echo "Skipping PostgREST deployment as requested"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.deploy_postgrest }}" == "true" ]]; then
            echo "deploy_postgrest=true" >> $GITHUB_OUTPUT
            echo "Manual request to deploy PostgREST"
          elif [[ -z "$PARENT_SHA" ]]; then
            echo "deploy_postgrest=true" >> $GITHUB_OUTPUT
            echo "First commit, deploying PostgREST"
          else
            CHANGED_FILES=$(git diff --name-only $PARENT_SHA $WORKFLOW_SHA 2>/dev/null || git ls-files)
            if echo "$CHANGED_FILES" | grep -q "^infra/postgrest/"; then
              echo "deploy_postgrest=true" >> $GITHUB_OUTPUT
              echo "PostgREST config changes detected"
            else
              echo "deploy_postgrest=false" >> $GITHUB_OUTPUT
              echo "No PostgREST config changes detected"
            fi
          fi

          # Check for nginx config changes
          if [[ "${{ github.event.inputs.deploy_nginx }}" == "false" ]]; then
            echo "deploy_nginx=false" >> $GITHUB_OUTPUT
            echo "Skipping nginx deployment as requested"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.deploy_nginx }}" == "true" ]]; then
            echo "deploy_nginx=true" >> $GITHUB_OUTPUT
            echo "Manual request to deploy nginx"
          elif [[ -z "$PARENT_SHA" ]]; then
            echo "deploy_nginx=true" >> $GITHUB_OUTPUT
            echo "First commit, deploying nginx"
          else
            CHANGED_FILES=$(git diff --name-only $PARENT_SHA $WORKFLOW_SHA 2>/dev/null || git ls-files)
            if echo "$CHANGED_FILES" | grep -q "^infra/nginx/"; then
              echo "deploy_nginx=true" >> $GITHUB_OUTPUT
              echo "Nginx config changes detected"
            else
              echo "deploy_nginx=false" >> $GITHUB_OUTPUT
              echo "No nginx config changes detected"
            fi
          fi

  test:
    needs: setup
    if: needs.setup.outputs.deploy_frontend == 'true' || needs.setup.outputs.deploy_email_service == 'true' || needs.setup.outputs.deploy_events_service == 'true' || needs.setup.outputs.deploy_image_service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm --filter @matrummet/shared --filter @matrummet/testing build

      - name: Run tests
        run: pnpm vitest run

  api-tests:
    needs: setup
    if: needs.setup.outputs.deploy_frontend == 'true' || needs.setup.outputs.run_migrations == 'true'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: matrummet
          POSTGRES_USER: matrummet
          POSTGRES_PASSWORD: matrummet
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U matrummet -d matrummet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Flyway migrations
        run: |
          docker run --rm \
            --network host \
            -v ${{ github.workspace }}/flyway/sql:/flyway/sql:ro \
            flyway/flyway:11 \
            -url=jdbc:postgresql://localhost:5433/matrummet \
            -user=matrummet \
            -password=matrummet \
            -locations=filesystem:/flyway/sql \
            -baselineOnMigrate=true \
            migrate

      - name: Seed test admin user
        run: PGPASSWORD=matrummet psql -h localhost -p 5433 -U matrummet -d matrummet -f tests/api/seed-admin.sql

      - name: Start PostgREST
        run: |
          docker run -d \
            --name postgrest \
            --network host \
            -e PGRST_DB_URI=postgres://matrummet:matrummet@localhost:5433/matrummet \
            -e PGRST_DB_SCHEMAS=public \
            -e PGRST_DB_ANON_ROLE=anon \
            -e PGRST_JWT_SECRET=matrummet-jwt-secret-change-in-production-min-32-chars \
            -e PGRST_JWT_SECRET_IS_BASE64=false \
            -e PGRST_JWT_ROLE_CLAIM_KEY=.role \
            -e PGRST_DB_PRE_REQUEST=pre_request \
            -e PGRST_DB_EXTRA_SEARCH_PATH=extensions \
            -e PGRST_OPENAPI_MODE=follow-privileges \
            -e PGRST_SERVER_PORT=4445 \
            postgrest/postgrest:v14.3

      - name: Wait for PostgREST to be ready
        run: |
          echo "Waiting for PostgREST to start..."
          for i in {1..30}; do
            if curl -s http://localhost:4445/ > /dev/null 2>&1; then
              echo "PostgREST is ready!"
              exit 0
            fi
            echo "Attempt $i: PostgREST not ready yet..."
            sleep 2
          done
          echo "PostgREST failed to start"
          docker logs postgrest
          exit 1

      - name: Run API integration tests
        env:
          TEST_POSTGREST_URL: http://localhost:4445
          TEST_JWT_SECRET: matrummet-jwt-secret-change-in-production-min-32-chars
          TEST_DB_HOST: localhost
          TEST_DB_PORT: "5433"
          TEST_DB_NAME: matrummet
          TEST_DB_USER: matrummet
          TEST_DB_PASSWORD: matrummet
        run: pnpm test:api

      - name: Show PostgREST logs on failure
        if: failure()
        run: docker logs postgrest

  deploy-migrations:
    needs: [setup, test, api-tests]
    if: always() && needs.setup.outputs.run_migrations == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.api-tests.result == 'success' || needs.api-tests.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy migrations
        run: |
          rsync -avz --delete --exclude='backups' flyway/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ vars.DEPLOY_PATH }}/flyway/

          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'source ${{ vars.DEPLOY_PATH }}/.flyway.env && cd ${{ vars.DEPLOY_PATH }}/flyway && ./run-flyway.sh migrate' || {
            echo "::error::Database migration failed. Please check the logs for details."
            exit 1
          }

          echo "Migrations deployed successfully"

  deploy-postgrest:
    needs: [setup, test, api-tests, deploy-migrations]
    if: always() && (needs.setup.outputs.deploy_postgrest == 'true' || needs.setup.outputs.run_migrations == 'true') && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.api-tests.result == 'success' || needs.api-tests.result == 'skipped') && (needs.deploy-migrations.result == 'success' || needs.deploy-migrations.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy PostgREST config
        if: needs.setup.outputs.deploy_postgrest == 'true'
        env:
          POSTGREST_DB_PASSWORD: ${{ secrets.POSTGREST_DB_PASSWORD }}
          POSTGREST_JWT_SECRET: ${{ secrets.POSTGREST_JWT_SECRET }}
        run: |
          REMOTE="${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}"
          STAGING="/tmp/postgrest-deploy"
          envsubst '${POSTGREST_DB_PASSWORD} ${POSTGREST_JWT_SECRET}' < infra/postgrest/matrummet.conf > /tmp/matrummet.conf
          ssh $REMOTE "mkdir -p $STAGING"
          scp /tmp/matrummet.conf $REMOTE:$STAGING/matrummet.conf
          ssh $REMOTE "
            sudo cp $STAGING/matrummet.conf /etc/postgrest/matrummet.conf &&
            sudo chown postgres:postgres /etc/postgrest/matrummet.conf &&
            sudo chmod 600 /etc/postgrest/matrummet.conf &&
            rm -rf $STAGING
          "

      - name: Restart PostgREST
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'sudo systemctl restart ${{ vars.SERVICE_POSTGREST }}'

  deploy-services:
    needs: [setup, test, api-tests, deploy-migrations, deploy-postgrest, deploy-nginx]
    if: always() && (needs.setup.outputs.deploy_frontend == 'true' || needs.setup.outputs.deploy_email_service == 'true' || needs.setup.outputs.deploy_events_service == 'true' || needs.setup.outputs.deploy_image_service == 'true') && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.api-tests.result == 'success' || needs.api-tests.result == 'skipped') && (needs.deploy-migrations.result == 'success' || needs.deploy-migrations.result == 'skipped') && (needs.deploy-postgrest.result == 'success' || needs.deploy-postgrest.result == 'skipped') && (needs.deploy-nginx.result == 'success' || needs.deploy-nginx.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [frontend, email-service, events-service, image-service]
      fail-fast: false
    steps:
      - name: Check if service should be deployed
        id: should-deploy
        run: |
          if [[ "${{ matrix.service }}" == "frontend" && "${{ needs.setup.outputs.deploy_frontend }}" == "true" ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.service }}" == "email-service" && "${{ needs.setup.outputs.deploy_email_service }}" == "true" ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.service }}" == "events-service" && "${{ needs.setup.outputs.deploy_events_service }}" == "true" ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.service }}" == "image-service" && "${{ needs.setup.outputs.deploy_image_service }}" == "true" ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.should-deploy.outputs.deploy == 'true'
        uses: actions/checkout@v4

      - name: Setup pnpm
        if: steps.should-deploy.outputs.deploy == 'true'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: steps.should-deploy.outputs.deploy == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        if: steps.should-deploy.outputs.deploy == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'frontend'
        working-directory: apps/web
        run: |
          pnpm --filter @matrummet/shared build
          pnpm build
          # Playwright can't be bundled by Nitro (uses __dirname, CJS internals)
          # Install it in a temp dir then copy to avoid npm touching sharp's platform deps
          tmp=$(mktemp -d) && (cd "$tmp" && npm init -y --silent && npm install --no-save playwright) && cp -r "$tmp/node_modules/playwright" "$tmp/node_modules/playwright-core" .output/server/node_modules/ && rm -rf "$tmp"
          ls -la .output/server/  # Verify build output exists

      - name: Build and prepare email-service deployment
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'email-service'
        run: |
          pnpm --filter @matrummet/shared build
          pnpm deploy --filter @matrummet/email-service --prod --legacy deploy/email-service
          ls -la deploy/email-service/  # Verify deployment package

      - name: Build and prepare events-service deployment
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'events-service'
        run: |
          pnpm --filter @matrummet/shared build
          pnpm deploy --filter @matrummet/events-service --prod --legacy deploy/events-service
          ls -la deploy/events-service/  # Verify deployment package

      - name: Build and prepare image-service deployment
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'image-service'
        run: |
          pnpm --filter @matrummet/shared build
          pnpm deploy --filter @matrummet/image-service --prod --legacy deploy/image-service
          ls -la deploy/image-service/  # Verify deployment package

      - name: Setup SSH
        if: steps.should-deploy.outputs.deploy == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy frontend to VPS
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'frontend'
        run: |
          rsync -avz --delete \
            apps/web/.output/ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ vars.DEPLOY_PATH }}/apps/web/.output/

          echo "Frontend deployed successfully"

      - name: Deploy email-service to VPS
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'email-service'
        run: |
          rsync -avz --delete \
            deploy/email-service/ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ vars.DEPLOY_PATH }}/apps/email-service/

          echo "Email-service deployed successfully"

      - name: Deploy events-service to VPS
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'events-service'
        run: |
          rsync -avz --delete \
            deploy/events-service/ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ vars.DEPLOY_PATH }}/apps/events-service/

          echo "Events-service deployed successfully"

      - name: Deploy image-service to VPS
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'image-service'
        run: |
          rsync -avz --delete \
            deploy/image-service/ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ vars.DEPLOY_PATH }}/apps/image-service/

          echo "Image-service deployed successfully"

      - name: Restart frontend service
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'frontend'
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'sudo systemctl restart ${{ vars.SERVICE_FRONTEND }}'

      - name: Restart email-service
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'email-service'
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'sudo systemctl restart ${{ vars.SERVICE_EMAIL }}'

      - name: Restart events-service
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'events-service'
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'sudo systemctl restart ${{ vars.SERVICE_EVENTS }}'

      - name: Restart image-service
        if: steps.should-deploy.outputs.deploy == 'true' && matrix.service == 'image-service'
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'sudo systemctl restart ${{ vars.SERVICE_IMAGE }}'

  deploy-nginx:
    needs: [setup, test, api-tests]
    if: always() && needs.setup.outputs.deploy_nginx == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.api-tests.result == 'success' || needs.api-tests.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy nginx config
        run: |
          REMOTE="${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}"
          STAGING="/tmp/nginx-deploy"
          ssh $REMOTE "mkdir -p $STAGING"
          scp infra/nginx/shared-locations.conf $REMOTE:$STAGING/matrummet-locations.conf
          scp infra/nginx/production.conf $REMOTE:$STAGING/recept
          scp infra/nginx/api.conf $REMOTE:$STAGING/api.matrummet.se
          scp infra/nginx/proxy-cache.conf $REMOTE:$STAGING/proxy-cache.conf
          CHANGED=$(ssh $REMOTE "
            changed=false
            diff -q $STAGING/matrummet-locations.conf /etc/nginx/snippets/matrummet-locations.conf >/dev/null 2>&1 || changed=true
            diff -q $STAGING/recept /etc/nginx/sites-enabled/recept >/dev/null 2>&1 || changed=true
            diff -q $STAGING/api.matrummet.se /etc/nginx/sites-enabled/api.matrummet.se >/dev/null 2>&1 || changed=true
            diff -q $STAGING/proxy-cache.conf /etc/nginx/conf.d/proxy-cache.conf >/dev/null 2>&1 || changed=true
            echo \$changed
          ")
          if [[ "$CHANGED" == "true" ]]; then
            echo "Nginx config changed, deploying and reloading"
            ssh $REMOTE "
              sudo cp $STAGING/matrummet-locations.conf /etc/nginx/snippets/matrummet-locations.conf &&
              sudo cp $STAGING/recept /etc/nginx/sites-enabled/recept &&
              sudo cp $STAGING/api.matrummet.se /etc/nginx/sites-enabled/api.matrummet.se &&
              sudo cp $STAGING/proxy-cache.conf /etc/nginx/conf.d/proxy-cache.conf &&
              sudo nginx -t && sudo systemctl reload nginx
            "
          else
            echo "Nginx config unchanged, skipping reload"
          fi
          ssh $REMOTE "rm -rf $STAGING"

  notify:
    needs: [setup, test, api-tests, deploy-migrations, deploy-services, deploy-postgrest, deploy-nginx]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment summary
        run: |
          echo "Deployment completed at $(date)"
          echo "Summary:"
          echo "- Unit Tests: ${{ needs.test.result == 'success' && 'Passed' || needs.test.result == 'skipped' && 'Skipped' || 'Failed' }}"
          echo "- API Tests: ${{ needs.api-tests.result == 'success' && 'Passed' || needs.api-tests.result == 'skipped' && 'Skipped' || 'Failed' }}"
          echo "- Migrations: ${{ needs.setup.outputs.run_migrations == 'true' && (needs.deploy-migrations.result == 'success' && 'Deployed' || 'Failed') || 'Skipped' }}"
          echo "- Frontend: ${{ needs.setup.outputs.deploy_frontend == 'true' && 'Deployed' || 'Skipped' }}"
          echo "- Email-service: ${{ needs.setup.outputs.deploy_email_service == 'true' && 'Deployed' || 'Skipped' }}"
          echo "- Events-service: ${{ needs.setup.outputs.deploy_events_service == 'true' && 'Deployed' || 'Skipped' }}"
          echo "- Image-service: ${{ needs.setup.outputs.deploy_image_service == 'true' && 'Deployed' || 'Skipped' }}"
          echo "- PostgREST: ${{ needs.setup.outputs.deploy_postgrest == 'true' && (needs.deploy-postgrest.result == 'success' && 'Deployed' || 'Failed') || 'Skipped' }}"
          echo "- Nginx: ${{ needs.setup.outputs.deploy_nginx == 'true' && (needs.deploy-nginx.result == 'success' && 'Deployed' || 'Failed') || 'Skipped' }}"
