# External Integrations

**Analysis Date:** 2026-01-27

## APIs & External Services

**Google Gemini AI:**
- Service: Google Generative AI API (Gemini 2.5 Flash)
- What it's used for: Recipe parsing from images and text, AI-powered recipe generation
- SDK/Client: `@google/genai` 1.34.0
- Auth: `GEMINI_API_KEY` environment variable
- Implementation files:
  - `apps/frontend/app/api/ai/generate/route.ts` - Credit-deducting AI generation endpoint
  - `apps/frontend/app/api/admin/gemini/parse/route.ts` - Admin recipe parsing
  - `apps/frontend/app/api/admin/gemini/refine/route.ts` - Admin recipe refinement
  - Model: `gemini-2.5-flash`
  - Request format: Multipart form data with text and/or base64-encoded images
  - Response: JSON validated against `RECIPE_SCHEMA` in `apps/frontend/lib/recipe-parser/types.ts`

**Google OAuth 2.0:**
- Service: Google Accounts OAuth 2.0 server
- What it's used for: Third-party authentication (sign up/login with Google)
- Auth: `GOOGLE_CLIENT_ID` and `GOOGLE_SECRET`
- Implementation files:
  - `apps/frontend/app/api/auth/google/route.ts` - OAuth initiation
  - `apps/frontend/app/api/auth/callback/google/route.ts` - OAuth callback handler
  - Scopes: `openid email profile`
  - Flow: Authorization code flow with offline access
  - Redirect URI: `{APP_URL}/api/auth/callback/google`

**Stripe Payment Processing:**
- Service: Stripe API v2024+
- What it's used for: Credit purchase checkout and payment processing
- SDK/Client: `stripe` 20.2.0 (server-side only)
- Auth: `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `STRIPE_PUBLISHABLE_KEY`
- Implementation files:
  - `apps/frontend/lib/stripe.ts` - Stripe client initialization and credit pack definitions
  - `apps/frontend/app/api/credits/checkout/route.ts` - Create checkout session
  - `apps/frontend/app/api/webhooks/stripe/route.ts` - Webhook handler for `checkout.session.completed`
  - Credit packs: 10 credits (29 SEK), 25 credits (59 SEK)
  - Webhook signature verification: HMAC-SHA256 validation
  - Webhook payload processing: Extracts user email and credits from session metadata

## Data Storage

**Databases:**
- PostgreSQL 18
  - Connection: `DATABASE_URL` or `db-uri` in `postgrest.cfg`
  - Client: `pg` 8.14.1 (Node.js driver for email-service)
  - Default connection: `postgres://recept@localhost:5432/recept` (dev)
  - Schemas: `public` (main), `auth` (authentication)
  - Row-level security enabled on all user-facing tables
  - Schema managed by Flyway migrations in `flyway/sql/`
  - Tables:
    - `users` - User accounts with email, name, provider
    - `recipes` - Recipe data with full-text search vector
    - `ingredients` - Recipe ingredients with measurements
    - `instructions` - Recipe preparation steps
    - `categories` - Recipe categories (many-to-many via `recipe_categories`)
    - `user_credits` - AI generation credit balances
    - `credit_transactions` - Audit ledger for credits (immutable)
    - `stripe_customers` - Email-to-Stripe customer mapping
    - `user_passwords` - Bcrypt-hashed passwords
    - `password_reset_tokens` - Time-limited reset tokens
    - `email_preferences` - User notification preferences
    - `shopping_lists` - User shopping lists
    - `user_likes` - Recipe favoriting

**File Storage:**
- Local filesystem only
- Image variants stored in `data/images/{imageId}/` directory:
  - Multiple WebP sizes: thumb (320x240), small (640x480), medium (960x720), large (1280x960), full (1920x1440)
  - Generated by `sharp` image processing library
  - Implementation: `apps/frontend/lib/image-processing.ts`
  - Upload endpoint: `apps/frontend/app/api/upload/route.ts`

**Caching:**
- None detected. Caching handled by PostgREST default behavior.

## Authentication & Identity

**Auth Provider:**
- Custom JWT-based authentication
- Implementation files:
  - `apps/frontend/lib/auth.ts` - Session management and JWT utilities
  - `apps/frontend/app/api/auth/login/route.ts` - Email/password login
  - `apps/frontend/app/api/auth/registrera/route.ts` - Email/password signup
  - `apps/frontend/app/api/auth/reset-password/validate/route.ts` - Password reset validation
  - `apps/frontend/app/api/auth/logout/route.ts` - Logout/session cleanup

- JWT structure:
  - Signed with `JWT_SECRET` (HS256 algorithm) for Next.js cookies
  - PostgREST JWTs signed with `POSTGREST_JWT_SECRET`
  - Email claim in JWT payload used for RLS (`request.jwt.claims->>'email'`)
  - Roles: `authenticated`, `anon`, admin roles via function-level grants

- Database functions:
  - `login(p_email, p_password)` - Validates password and returns user
  - `signup(p_name, p_email, p_password)` - Creates user and grants 10 free credits
  - `signup_provider(p_name, p_email, p_provider)` - OAuth signup
  - `reset_password(p_email, p_token, p_new_password)` - Password reset

- Optional: Google OAuth 2.0 (see Google OAuth section above)

## Monitoring & Observability

**Error Tracking:**
- Not detected. Errors logged to stdout/console.

**Logs:**
- Console logging via `@recept/shared` logger in email-service
- Implementation: `apps/email-service/src/index.ts` uses `createLogger({ service: "email-service" })`
- Frontend errors logged to browser console
- Database errors propagated through PostgREST response

## CI/CD & Deployment

**Hosting:**
- Not specified in codebase. Assumed to be deployed to:
  - Frontend: Vercel, Railway, or self-hosted Node.js
  - Email service: Self-hosted Node.js or Docker
  - Database: Managed PostgreSQL or self-hosted

**CI Pipeline:**
- Not detected in codebase. Test infrastructure present but no CI config found.

## Environment Configuration

**Required env vars:**
- `POSTGREST_URL` - PostgREST API base URL (default: `http://localhost:4444`)
- `JWT_SECRET` - Next.js session signing key (32+ chars)
- `POSTGREST_JWT_SECRET` - PostgREST JWT signing key (32+ chars)

**Optional env vars (features):**
- `GEMINI_API_KEY` - Google Gemini API key (AI recipe parsing disabled if missing)
- `STRIPE_SECRET_KEY` - Stripe secret API key (credit system disabled if missing)
- `STRIPE_PUBLISHABLE_KEY` - Stripe publishable key (credit UI disabled if missing)
- `STRIPE_WEBHOOK_SECRET` - Stripe webhook signing key (webhook verification)
- `GOOGLE_CLIENT_ID` - Google OAuth client ID (Google login disabled if missing)
- `GOOGLE_SECRET` - Google OAuth secret (Google login disabled if missing)
- `RECIPE_IMPORT_API_KEY` - Internal API key for programmatic recipe imports
- `RECIPE_IMPORT_EMAIL` - Email owner for imported recipes
- `APP_URL` - Public application URL (used in OAuth redirects)
- `CRON_SECRET` - Secret for scheduled task endpoints

**Secrets location:**
- Development: `.env.local` files (git-ignored)
- Production: Environment variables in hosting platform or `.env` file (not committed)

## Webhooks & Callbacks

**Incoming:**
- Stripe webhook: `POST /api/webhooks/stripe`
  - Event: `checkout.session.completed`
  - Signature verification: Stripe HMAC-SHA256
  - Action: Adds credits via `add_credits()` RPC after verifying payment
  - Implementation: `apps/frontend/app/api/webhooks/stripe/route.ts`

**Outgoing:**
- None detected.

## Recipe Import & Parsing

**URL-based Recipe Import:**
- Endpoint: `POST /api/recipes/import`
- Flow:
  1. Fetches recipe from external URL (e.g., recipe blog)
  2. Parses HTML with Cheerio (`cheerio` 1.1.2)
  3. Extracts JSON-LD structured data
  4. Maps ingredients to internal food database via `search_foods()` RPC
  5. Maps units via `search_units()` RPC
  6. Stores recipe via `insert_recipe()` RPC
- Implementation: `apps/frontend/app/api/recipes/import/route.ts`
- Auth: Requires valid `RECIPE_IMPORT_API_KEY` header or authenticated user
- Response: Parsed and stored recipe as JSON

**Image Processing for Recipes:**
- Supports JPEG, PNG, WebP, GIF (max 10 MB)
- Generates multiple WebP variants via `sharp`
- Sizes: thumb, small, medium, large, full (see File Storage)
- Implementation: `apps/frontend/lib/image-processing.ts`

## API Layer

**PostgREST REST API:**
- Base URL: `POSTGREST_URL` (default: `http://localhost:4444`)
- Configuration: `postgrest.cfg`
- Version: 14.3 (in test Docker image)
- Schemas exposed: `public`, `auth`
- Role claim: JWT `.role` claim
- Anonymous role: `anon`
- Pre-request function: `pre_request()` (PostgreSQL function)
- OpenAPI mode: `ignore-privileges` (OpenAPI docs expose internal functions)

- Auto-generated endpoints from tables:
  - Tables: `/recipes`, `/ingredients`, `/instructions`, `/categories`, `/users`, etc.
  - RPC: `/rpc/{function_name}` for PostgreSQL functions
  - Common functions called from frontend:
    - `/rpc/login` - User authentication
    - `/rpc/signup` - User registration
    - `/rpc/signup_provider` - OAuth signup
    - `/rpc/insert_recipe` - Atomic recipe insert with categories/ingredients/instructions
    - `/rpc/update_recipe` - Atomic recipe update
    - `/rpc/search_foods` - Full-text food search
    - `/rpc/search_units` - Unit lookup
    - `/rpc/deduct_credit` - Atomic credit deduction
    - `/rpc/add_credits` - Admin/webhook credit granting
    - `/rpc/get_user_credits` - Check credit balance
    - `/rpc/get_credit_history` - Audit trail

---

*Integration audit: 2026-01-27*
