---
phase: 02-settings-sidebar-layout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/app/(main)/installningar/layout.tsx
  - apps/frontend/app/(main)/installningar/page.tsx
  - apps/frontend/app/(main)/installningar/sakerhet/page.tsx
  - apps/frontend/app/(main)/installningar/api-nycklar/page.tsx
  - apps/frontend/components/settings-sidebar.tsx
  - apps/frontend/components/settings-pill-nav.tsx
autonomous: true

must_haves:
  truths:
    - "Desktop settings page shows a 240px vertical sidebar with Profil, Sakerhet, API-nycklar links and a separated Farlig zon / Konto link"
    - "Mobile settings page shows horizontal scrolling pill tabs with all four sections"
    - "Active section is highlighted in sidebar/pills with aria-current='page'"
    - "Settings pages no longer render the old horizontal tab navigation"
  artifacts:
    - path: "apps/frontend/components/settings-sidebar.tsx"
      provides: "Desktop sidebar navigation with danger zone separator"
      contains: "SettingsSidebar"
    - path: "apps/frontend/components/settings-pill-nav.tsx"
      provides: "Mobile pill tab navigation"
      contains: "SettingsPillNav"
    - path: "apps/frontend/app/(main)/installningar/layout.tsx"
      provides: "CSS Grid layout with sidebar + content areas"
      contains: "grid-cols-[240px_1fr]"
  key_links:
    - from: "apps/frontend/app/(main)/installningar/layout.tsx"
      to: "apps/frontend/components/settings-sidebar.tsx"
      via: "import and render in grid aside"
      pattern: "SettingsSidebar"
    - from: "apps/frontend/app/(main)/installningar/layout.tsx"
      to: "apps/frontend/components/settings-pill-nav.tsx"
      via: "import and render for mobile"
      pattern: "SettingsPillNav"
---

<objective>
Create the settings sidebar layout infrastructure: a vertical sidebar component for desktop, a horizontal pill navigation for mobile, and a CSS Grid layout in the settings layout.tsx. Also strip the old SettingsViewToggle from all settings page components.

Purpose: This implements the core navigation structure for REQ-01 (sidebar on desktop, stacked links on mobile) and REQ-02 (Profil, Sakerhet, API-nycklar sections) with the Konto danger zone link for REQ-03.

Output: Two new navigation components (SettingsSidebar, SettingsPillNav), an updated layout.tsx with CSS Grid, and cleaned-up settings pages without SettingsViewToggle.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-settings-sidebar-layout/02-RESEARCH.md
@.planning/phases/02-settings-sidebar-layout/02-CONTEXT.md
@apps/frontend/app/(main)/installningar/layout.tsx
@apps/frontend/components/settings-view-toggle.tsx
@apps/frontend/components/ui/separator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sidebar and pill navigation components</name>
  <files>
    apps/frontend/components/settings-sidebar.tsx
    apps/frontend/components/settings-pill-nav.tsx
  </files>
  <action>
Create two new client components:

**settings-sidebar.tsx** — Desktop vertical sidebar:
- "use client" (needs usePathname)
- Import Link from "next/link", usePathname from "next/navigation", cn from "@/lib/utils", Separator from "@/components/ui/separator"
- Define settingsLinks array: [{href: "/installningar", label: "Profil"}, {href: "/installningar/sakerhet", label: "Säkerhet"}, {href: "/installningar/api-nycklar", label: "API-nycklar"}]
- Define dangerLinks array: [{href: "/installningar/konto", label: "Konto"}]
- Export function SettingsSidebar
- Use usePathname() to detect active link
- Active link styling: "bg-muted text-foreground font-medium" on a rounded-md pill
- Inactive styling: "text-muted-foreground hover:bg-muted/50 hover:text-foreground"
- Nav wrapper: `<nav aria-label="Inställningar" className="sticky top-20 space-y-6">`
- Regular links in a `<div className="space-y-1">` section
- After regular links: `<div className="space-y-1">` containing a `<Separator />`, then `<p className="px-3 pt-4 pb-2 text-xs font-semibold text-muted-foreground uppercase tracking-wider">Farlig zon</p>`, then the Konto link
- Konto link uses additional classes: "text-destructive hover:text-destructive hover:bg-destructive/10" (merged via cn with getLinkStyles, but with destructive overrides)
- Each link gets `aria-current={pathname === href ? "page" : undefined}`
- Links are `<Link>` components with `className={cn("block px-3 py-2 rounded-md text-sm transition-colors", ...)}`

**settings-pill-nav.tsx** — Mobile horizontal pill tabs:
- "use client" (needs usePathname)
- Import Link from "next/link", usePathname from "next/navigation", cn from "@/lib/utils"
- Define navItems array: [{href: "/installningar", label: "Profil"}, {href: "/installningar/sakerhet", label: "Säkerhet"}, {href: "/installningar/api-nycklar", label: "API-nycklar"}, {href: "/installningar/konto", label: "Konto"}]
- Export function SettingsPillNav
- Outer: `<nav aria-label="Inställningar" className="overflow-x-auto">`
- Inner: `<div className="flex gap-2 pb-2">`
- Each item: `<Link className={cn("flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap", ...)}>`
- Active regular pill: "bg-warm text-warm-foreground"
- Active danger pill: "bg-destructive text-destructive-foreground"
- Inactive regular pill: "bg-muted text-muted-foreground hover:bg-muted/80 hover:text-foreground"
- Inactive danger pill: "bg-muted text-destructive hover:bg-destructive/10"
- Detect isDanger via `item.href.includes("/konto")`
- Each pill gets `aria-current={isActive ? "page" : undefined}`
  </action>
  <verify>
Both files exist and export their components:
```bash
grep -l "export function Settings" apps/frontend/components/settings-sidebar.tsx apps/frontend/components/settings-pill-nav.tsx
```
Check aria-current is present in both:
```bash
grep "aria-current" apps/frontend/components/settings-sidebar.tsx apps/frontend/components/settings-pill-nav.tsx
```
  </verify>
  <done>
SettingsSidebar renders vertical nav with 3 regular links + Farlig zon separator + Konto link, using sticky positioning and active state detection. SettingsPillNav renders horizontal scrolling pills for all 4 sections with danger styling on Konto. Both use aria-current="page" for accessibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update settings layout to CSS Grid and strip SettingsViewToggle from pages</name>
  <files>
    apps/frontend/app/(main)/installningar/layout.tsx
    apps/frontend/app/(main)/installningar/page.tsx
    apps/frontend/app/(main)/installningar/sakerhet/page.tsx
    apps/frontend/app/(main)/installningar/api-nycklar/page.tsx
  </files>
  <action>
**Update layout.tsx:**
- Change max-width from "max-w-2xl" to "max-w-6xl" (accommodate sidebar + content)
- Import SettingsSidebar from "@/components/settings-sidebar"
- Import SettingsPillNav from "@/components/settings-pill-nav"
- Restructure children area to use CSS Grid:
  ```
  <div className="grid grid-cols-1 md:grid-cols-[240px_1fr] gap-8">
    <aside className="hidden md:block">
      <SettingsSidebar />
    </aside>
    <div className="md:hidden">
      <SettingsPillNav />
    </div>
    <main className="min-w-0">
      {children}
    </main>
  </div>
  ```
- Keep the existing heading section (h1 "Inställningar" + subtitle) above the grid
- Keep the existing auth check (getSession + redirect)

**Update page.tsx (Profil):**
- Remove `import { SettingsViewToggle } from '@/components/settings-view-toggle'`
- Remove `<SettingsViewToggle activeView="profil" />`
- Add an h2 heading: `<h2 className="text-2xl font-semibold mb-6">Profil</h2>` before ProfileForm
- Keep ProfileForm import and usage

**Update sakerhet/page.tsx:**
- Remove `import { SettingsViewToggle } from '@/components/settings-view-toggle'`
- Remove `<SettingsViewToggle activeView="sakerhet" />`
- Add an h2 heading: `<h2 className="text-2xl font-semibold mb-6">Säkerhet</h2>` before SecurityForm
- Keep SecurityForm import and usage

**Update api-nycklar/page.tsx:**
- Remove `import { SettingsViewToggle } from '@/components/settings-view-toggle'`
- Remove `<SettingsViewToggle activeView="api-nycklar" />`
- Add an h2 heading: `<h2 className="text-2xl font-semibold mb-6">API-nycklar</h2>` before ApiKeyManager
- Keep all existing imports and the `dynamic = 'force-dynamic'` export
  </action>
  <verify>
No SettingsViewToggle imports remain in settings pages:
```bash
grep -r "SettingsViewToggle" apps/frontend/app/\(main\)/installningar/page.tsx apps/frontend/app/\(main\)/installningar/sakerhet/page.tsx apps/frontend/app/\(main\)/installningar/api-nycklar/page.tsx
```
Layout has grid classes:
```bash
grep "grid-cols-\[240px_1fr\]" apps/frontend/app/\(main\)/installningar/layout.tsx
```
Build succeeds:
```bash
pnpm build
```
  </verify>
  <done>
Settings layout uses CSS Grid with 240px sidebar column on desktop. All three existing settings pages (profil, sakerhet, api-nycklar) render without SettingsViewToggle, showing only their section heading and content component.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "SettingsViewToggle" apps/frontend/app/(main)/installningar/` returns only hemmet/page.tsx (which Plan 02 handles)
2. `grep "grid-cols" apps/frontend/app/(main)/installningar/layout.tsx` shows grid layout
3. `grep "aria-current" apps/frontend/components/settings-sidebar.tsx apps/frontend/components/settings-pill-nav.tsx` shows accessibility attributes in both
4. `grep "Farlig zon" apps/frontend/components/settings-sidebar.tsx` confirms danger zone separator
5. `pnpm build` succeeds without errors
</verification>

<success_criteria>
- Settings layout renders CSS Grid with 240px sidebar on desktop (md+)
- SettingsSidebar shows Profil, Sakerhet, API-nycklar links with Farlig zon separator and Konto link
- SettingsPillNav shows horizontal scrolling pills for all 4 sections
- Mobile shows pills, desktop shows sidebar (responsive via hidden/block)
- Active link detection works via usePathname()
- aria-current="page" on active links in both components
- No SettingsViewToggle imports in profil, sakerhet, or api-nycklar pages
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-settings-sidebar-layout/02-01-SUMMARY.md`
</output>
