---
phase: 02-settings-sidebar-layout
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/app/(main)/installningar/konto/page.tsx
  - apps/frontend/components/account-deletion-form.tsx
  - apps/frontend/components/security-form.tsx
  - apps/frontend/components/settings-view-toggle.tsx
  - apps/frontend/app/(main)/installningar/hemmet/page.tsx
autonomous: true

must_haves:
  truths:
    - "Account deletion appears only on /installningar/konto, not on /installningar/sakerhet"
    - "Konto page requires typing email address to enable delete button"
    - "SecurityForm shows only password change with no account deletion UI"
    - "SettingsViewToggle component file is deleted from codebase"
    - "Old hemmet settings page is deleted (redirect handles the route)"
  artifacts:
    - path: "apps/frontend/app/(main)/installningar/konto/page.tsx"
      provides: "Danger zone account page"
      contains: "AccountDeletionForm"
    - path: "apps/frontend/components/account-deletion-form.tsx"
      provides: "Account deletion with email confirmation"
      contains: "emailConfirmation"
  key_links:
    - from: "apps/frontend/app/(main)/installningar/konto/page.tsx"
      to: "apps/frontend/components/account-deletion-form.tsx"
      via: "import and render"
      pattern: "AccountDeletionForm"
    - from: "apps/frontend/components/account-deletion-form.tsx"
      to: "/api/user/delete-account"
      via: "fetch POST on form submit"
      pattern: "delete-account"
---

<objective>
Extract account deletion from SecurityForm into a standalone AccountDeletionForm component with email confirmation, create the new /installningar/konto danger zone page, and clean up deprecated files (SettingsViewToggle, hemmet settings page).

Purpose: This implements REQ-03 (delete account as own danger zone section, separate from password change) and completes the old component removal required by the phase success criteria (SC-05).

Output: New Konto page with AccountDeletionForm, trimmed SecurityForm (password-only), deleted SettingsViewToggle file, deleted hemmet settings page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-settings-sidebar-layout/02-RESEARCH.md
@.planning/phases/02-settings-sidebar-layout/02-CONTEXT.md
@apps/frontend/components/security-form.tsx
@apps/frontend/components/settings-view-toggle.tsx
@apps/frontend/app/(main)/installningar/hemmet/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AccountDeletionForm and Konto page</name>
  <files>
    apps/frontend/components/account-deletion-form.tsx
    apps/frontend/app/(main)/installningar/konto/page.tsx
  </files>
  <action>
**Create account-deletion-form.tsx:**
- "use client" component
- Extract and enhance the delete account logic from security-form.tsx (lines 33-37 state, lines 78-115 handler, lines 117-123 dialog handler, lines 177-251 JSX)
- Import: useState from "react", useRouter from "next/navigation", useAuth from "@/components/auth-provider", Button/Input/Label/Alert/AlertDescription/Dialog/DialogContent/DialogDescription/DialogFooter/DialogHeader/DialogTitle/DialogTrigger
- Export function AccountDeletionForm
- Key enhancement over existing: Add EMAIL CONFIRMATION field. User must type their email to enable the delete button
- State: dialogOpen, emailConfirmation (NEW), password, error, isLoading
- Derive from useAuth: `const { user, clearUser } = useAuth()`
- `const isOAuthUser = user?.provider !== null`
- `const isEmailValid = emailConfirmation === user?.email`
- `const canDelete = isEmailValid && (isOAuthUser || password)` — both email match AND password (for non-OAuth) required
- handleDelete: POST to "/api/user/delete-account" with JSON body `{ password: isOAuthUser ? null : password }`, on success: clearUser(), router.push("/"), router.refresh()
- handleDialogChange: resets emailConfirmation, password, error when closing
- Outer wrapper: `<div className="bg-card border border-destructive/50 rounded-lg p-6">`
- h3: `<h3 className="text-lg font-semibold mb-4 text-destructive">Radera konto</h3>`
- Explanatory text: Two paragraphs — "Om du raderar ditt konto..." and "Denna åtgärd kan inte ångras."
- Dialog trigger: `<Button variant="destructive">Radera mitt konto</Button>` (no Trash2 icon)
- Dialog content: title "Bekräfta radering av konto", description about permanent deletion
- Dialog fields: (1) Email confirmation with label "Bekräfta genom att skriva din e-postadress: {user.email in bold}", Input type="email" with placeholder={user?.email}. (2) Password field for non-OAuth users only with label "Ditt lösenord"
- Error Alert (if error)
- Dialog footer: Avbryt (outline) + "Radera mitt konto" (destructive, disabled={!canDelete || isLoading})

**Create konto/page.tsx:**
- Import AccountDeletionForm from "@/components/account-deletion-form"
- Export default function AccountPage
- Return div with space-y-6:
  - Heading section: h2 "Konto" (text-2xl font-semibold mb-2) + p subtitle "Hantera ditt konto och radering" (text-muted-foreground)
  - AccountDeletionForm component
  </action>
  <verify>
Konto page and form exist:
```bash
ls apps/frontend/app/\(main\)/installningar/konto/page.tsx apps/frontend/components/account-deletion-form.tsx
```
Email confirmation pattern exists:
```bash
grep "emailConfirmation" apps/frontend/components/account-deletion-form.tsx
```
  </verify>
  <done>
/installningar/konto page renders AccountDeletionForm with email confirmation requirement. Delete button is disabled until user types their email address. Non-OAuth users also need password. Dialog provides two-step confirmation flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Strip deletion from SecurityForm and delete deprecated files</name>
  <files>
    apps/frontend/components/security-form.tsx
    apps/frontend/components/settings-view-toggle.tsx
    apps/frontend/app/(main)/installningar/hemmet/page.tsx
  </files>
  <action>
**Update security-form.tsx — remove ALL account deletion code:**
- Remove state: deleteDialogOpen, deletePassword, deleteError, isDeleteLoading (lines 33-37)
- Remove handler: handleDeleteAccount function (lines 78-115)
- Remove handler: handleDeleteDialogChange function (lines 117-123)
- Remove imports that are only used by deletion: Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger, Trash2
- Keep imports used by password section: useState, useRouter (may not be needed anymore — check), useAuth, Button, Input, Label, Alert, AlertDescription, changePasswordSchema, Check
- Actually useRouter is only used by deletion (router.push, router.refresh). Remove useRouter import and usage.
- Remove the entire "Delete account section" JSX block (lines 177-251): the div with border-destructive/50 containing the Dialog
- Keep the outer `<div className="space-y-8">` wrapper but it now only contains the password section
- The password section (lines 128-175) stays completely unchanged — it shows only for non-OAuth users (user?.provider === null check)
- Verify: SecurityForm should export a component that ONLY does password change. No Dialog imports, no Trash2, no deletePassword state, no handleDeleteAccount

**Delete settings-view-toggle.tsx:**
- Delete the file `apps/frontend/components/settings-view-toggle.tsx`
- This component is no longer imported by any file (Plan 02-01 removes all page imports; hemmet/page.tsx is also being deleted here)

**Delete hemmet/page.tsx:**
- Delete the file `apps/frontend/app/(main)/installningar/hemmet/page.tsx`
- The redirect in next.config.ts already handles `/installningar/hemmet` -> `/hemmet`
- This page was the old settings-embedded hemmet tab; Phase 1 created the standalone `/hemmet` route
- After deletion, remove the `hemmet` directory: `rm -rf apps/frontend/app/(main)/installningar/hemmet/`
  </action>
  <verify>
No deletion UI in SecurityForm:
```bash
grep -c "deleteDialogOpen\|handleDeleteAccount\|Radera\|Trash2\|Dialog" apps/frontend/components/security-form.tsx
```
Should return 0.

SettingsViewToggle file deleted:
```bash
test ! -f apps/frontend/components/settings-view-toggle.tsx && echo "DELETED"
```

Hemmet settings page deleted:
```bash
test ! -d apps/frontend/app/\(main\)/installningar/hemmet && echo "DELETED"
```

No remaining imports of SettingsViewToggle:
```bash
grep -r "SettingsViewToggle" apps/frontend/ || echo "CLEAN"
```

Build succeeds:
```bash
pnpm build
```
  </verify>
  <done>
SecurityForm contains only password change (no deletion UI, no Dialog imports). SettingsViewToggle file is deleted from codebase. Hemmet settings page is deleted (redirect handles the old route). No orphan imports remain.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "SettingsViewToggle" apps/frontend/` returns nothing (file deleted, all imports removed)
2. `grep "Dialog\|Trash2\|deleteDialog\|handleDeleteAccount" apps/frontend/components/security-form.tsx` returns nothing
3. `grep "emailConfirmation" apps/frontend/components/account-deletion-form.tsx` confirms email confirmation exists
4. `/installningar/konto/page.tsx` exists and imports AccountDeletionForm
5. `apps/frontend/app/(main)/installningar/hemmet/` directory does not exist
6. `pnpm build` succeeds
</verification>

<success_criteria>
- AccountDeletionForm requires email confirmation to enable delete button
- Konto page renders only account deletion (no password change, no other settings)
- SecurityForm has zero traces of account deletion (no Dialog, no Trash2, no delete state)
- SettingsViewToggle file is fully deleted from the codebase
- Hemmet settings page and directory are fully deleted
- No orphan imports anywhere in the codebase
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-settings-sidebar-layout/02-02-SUMMARY.md`
</output>
