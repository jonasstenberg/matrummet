---
phase: 04-desktop-header-restructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/package.json
  - apps/frontend/components/ui/dropdown-menu.tsx
  - apps/frontend/components/ui/tooltip.tsx
  - apps/frontend/components/desktop-nav.tsx
  - apps/frontend/components/user-avatar.tsx
autonomous: true

must_haves:
  truths:
    - "Desktop nav component renders 5 nav items horizontally with correct labels and routes"
    - "AI-krediter displays as Sparkles icon with credit count badge and tooltip"
    - "Admin nav item only renders when isAdmin(user) returns true"
    - "Active route gets underline indicator and aria-current='page'"
    - "User avatar shows initials extracted from name or email"
  artifacts:
    - path: "apps/frontend/components/desktop-nav.tsx"
      provides: "Horizontal nav items with active state detection"
      exports: ["DesktopNav"]
    - path: "apps/frontend/components/user-avatar.tsx"
      provides: "User initials circle component"
      exports: ["UserAvatar"]
    - path: "apps/frontend/components/ui/dropdown-menu.tsx"
      provides: "Radix UI DropdownMenu wrapper"
      exports: ["DropdownMenu", "DropdownMenuTrigger", "DropdownMenuContent", "DropdownMenuItem"]
    - path: "apps/frontend/components/ui/tooltip.tsx"
      provides: "Radix UI Tooltip wrapper"
      exports: ["Tooltip", "TooltipTrigger", "TooltipContent", "TooltipProvider"]
  key_links:
    - from: "apps/frontend/components/desktop-nav.tsx"
      to: "next/navigation"
      via: "usePathname for active route detection"
      pattern: "usePathname"
    - from: "apps/frontend/components/desktop-nav.tsx"
      to: "/api/credits/balance"
      via: "fetch for credit count badge"
      pattern: "fetch.*credits/balance"
    - from: "apps/frontend/components/desktop-nav.tsx"
      to: "apps/frontend/lib/is-admin.ts"
      via: "conditional Admin rendering"
      pattern: "isAdmin"
---

<objective>
Create the UI building blocks for the desktop header restructure: Radix UI primitives (DropdownMenu, Tooltip), a DesktopNav component with all 5 nav items (including AI-krediter icon with badge/tooltip and admin-gated Admin link), and a UserAvatar initials component.

Purpose: These components are the foundation that Plan 02 wires into the header. Building them separately ensures each is well-crafted and testable.
Output: 5 files - 2 UI primitives, 1 desktop nav component, 1 avatar component, and updated package.json.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-desktop-header-restructure/04-CONTEXT.md
@.planning/phases/04-desktop-header-restructure/04-RESEARCH.md

Key source files to reference:
@apps/frontend/components/header.tsx (current header - see nav items and routes)
@apps/frontend/components/settings-pill-nav.tsx (existing usePathname + aria-current pattern)
@apps/frontend/components/ui/badge.tsx (existing Badge component to use in credit badge)
@apps/frontend/components/ui/sheet.tsx (existing Radix wrapper pattern to follow)
@apps/frontend/components/auth-provider.tsx (useAuth hook for user data)
@apps/frontend/lib/is-admin.ts (admin check helper)
@apps/frontend/lib/types.ts (User type - note: no credits field, must fetch separately)
@apps/frontend/app/globals.css (Tailwind v4 theme - color variables)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Radix packages and create UI primitives</name>
  <files>
    apps/frontend/package.json
    apps/frontend/components/ui/dropdown-menu.tsx
    apps/frontend/components/ui/tooltip.tsx
  </files>
  <action>
    1. Install `@radix-ui/react-dropdown-menu` and `@radix-ui/react-tooltip` in `apps/frontend`:
       ```
       cd apps/frontend && pnpm add @radix-ui/react-dropdown-menu @radix-ui/react-tooltip
       ```

    2. Create `dropdown-menu.tsx` following the same pattern as `sheet.tsx` (Radix primitive + cn utility + Tailwind styling). Export: DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator. Use shadcn/ui dropdown-menu as reference but adapted to this project's styling (warm palette, Tailwind v4 variables).

    3. Create `tooltip.tsx` following same pattern. Export: Tooltip, TooltipTrigger, TooltipContent, TooltipProvider. Style tooltip content with `bg-popover text-popover-foreground px-3 py-1.5 text-sm rounded-md shadow-md border border-border`. Default delayDuration: 700ms.

    Both UI primitives should be "use client" components matching the existing pattern in sheet.tsx (forwardRef, cn utility, displayName).
  </action>
  <verify>
    - `pnpm build` completes without errors (run with `.claude/hooks/run-silent.sh "Build" "pnpm build"`)
    - Both files export expected components
    - TypeScript compiles cleanly
  </verify>
  <done>
    dropdown-menu.tsx and tooltip.tsx exist as reusable Radix UI wrappers matching project conventions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DesktopNav and UserAvatar components</name>
  <files>
    apps/frontend/components/desktop-nav.tsx
    apps/frontend/components/user-avatar.tsx
  </files>
  <action>
    1. Create `user-avatar.tsx`:
       - Props: `{ user: User, className?: string }`
       - Extract initials: if user.name has 2+ words, take first letter of first and last word; if single word, take first 2 chars; fallback to first 2 chars of email. Always uppercase.
       - Render: `div` with `h-9 w-9 rounded-full bg-warm text-warm-foreground flex items-center justify-center text-sm font-medium select-none`
       - Add `aria-label={user.name || user.email}`
       - "use client" is NOT needed (no hooks, pure render)

    2. Create `desktop-nav.tsx` ("use client"):
       - Import: `usePathname` from next/navigation, `useAuth` from auth-provider, `isAdmin` from lib/is-admin, `Link` from next/link, `Sparkles` from lucide-react, `Badge` from ui/badge, Tooltip components from ui/tooltip, `cn` from lib/utils
       - Define nav items array:
         ```
         { href: '/mitt-skafferi', label: 'Mitt skafferi' }
         { href: '/inkopslista', label: 'InkÃ¶pslista' }
         { href: '/hemmet', label: 'Mitt hem' }
         ```
         These are text-label nav items. AI-krediter and Admin are rendered separately.

       - Active state detection: Use `pathname === item.href` for exact matches. For Admin, use `pathname.startsWith('/admin')`.
       - Active indicator styling: Each nav link gets `relative` positioning with an `::after` pseudo-element for the underline. Use Tailwind classes:
         ```
         'relative px-3 py-2 text-sm font-medium transition-colors rounded-md'
         'hover:bg-muted/50'
         'after:absolute after:bottom-0 after:left-0 after:right-0 after:h-[3px] after:rounded-full after:bg-accent'
         'after:transition-transform after:duration-200 after:ease-out'
         isActive ? 'text-foreground after:scale-x-100' : 'text-muted-foreground after:scale-x-0'
         ```
       - Add `aria-current={isActive ? 'page' : undefined}` to each link.

       - AI-krediter nav item:
         - Fetch credit count on mount via `fetch('/api/credits/balance')` in a useEffect. Store in local state (default: null, show badge only when loaded).
         - Wrap in TooltipProvider (delayDuration={700}) > Tooltip > TooltipTrigger (asChild on Link).
         - Link to `/krediter` with `relative` class, Sparkles icon (h-5 w-5), and Badge positioned `absolute -top-2 -right-2.5` with `min-w-[1.25rem] h-5 px-1 text-[10px]` showing credit count.
         - Same underline pattern as other items.
         - TooltipContent: "AI-krediter", side="bottom", sideOffset={8}.
         - aria-label on the link: `AI-krediter (${credits} krediter kvar)` or "AI-krediter" if credits not loaded.

       - Admin nav item:
         - Only render if `isAdmin(user)`.
         - Same styling as text nav items.
         - Active when `pathname.startsWith('/admin')`.

       - The component renders a `<nav aria-label="Huvudnavigering">` wrapping all items in a flex container with `gap-1`.
       - Export the component as `DesktopNav`.
  </action>
  <verify>
    - `pnpm build` completes without errors
    - DesktopNav imports and uses usePathname, isAdmin, Badge, Tooltip correctly
    - UserAvatar renders initials from user data
    - TypeScript compiles cleanly
  </verify>
  <done>
    DesktopNav renders 5 nav items (3 text + 1 icon + 1 admin-gated) with active underline indicators. UserAvatar renders user initials in a circle. Both follow existing project conventions.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes (no TypeScript errors)
- All 5 new/modified files exist with correct exports
- DesktopNav uses usePathname for active detection (not window.location)
- DesktopNav uses isAdmin for Admin visibility
- DesktopNav uses aria-current="page" on active items
- UserAvatar extracts initials from user.name or user.email
</verification>

<success_criteria>
- UI primitives (dropdown-menu, tooltip) exist and follow Radix wrapper pattern from sheet.tsx
- DesktopNav component renders all 5 nav items with correct routes, labels, and active states
- AI-krediter shows Sparkles icon with credit count badge and tooltip
- Admin only visible to admin users
- UserAvatar shows user initials in a warm-colored circle
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-desktop-header-restructure/04-01-SUMMARY.md`
</output>
