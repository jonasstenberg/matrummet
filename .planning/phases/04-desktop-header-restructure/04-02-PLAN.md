---
phase: 04-desktop-header-restructure
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/frontend/components/header.tsx
autonomous: false

must_haves:
  truths:
    - "Desktop header shows Logo, then nav items (Mitt skafferi, Inköpslista, Mitt hem, AI-krediter icon, Admin), then user avatar/dropdown"
    - "User dropdown contains only Inställningar and Logga ut (5 items removed)"
    - "User dropdown trigger is initials circle (UserAvatar), not text button"
    - "User dropdown opens on click using Radix DropdownMenu (not hand-rolled)"
    - "Search bar remains in desktop nav area (will be moved to dedicated row in Phase 5)"
    - "Mobile menu and mobile search bar remain unchanged"
  artifacts:
    - path: "apps/frontend/components/header.tsx"
      provides: "Restructured desktop header with top-level nav items and slim dropdown"
      contains: "DesktopNav"
  key_links:
    - from: "apps/frontend/components/header.tsx"
      to: "apps/frontend/components/desktop-nav.tsx"
      via: "import and render in desktop section"
      pattern: "import.*DesktopNav"
    - from: "apps/frontend/components/header.tsx"
      to: "apps/frontend/components/user-avatar.tsx"
      via: "import for dropdown trigger"
      pattern: "import.*UserAvatar"
    - from: "apps/frontend/components/header.tsx"
      to: "apps/frontend/components/ui/dropdown-menu.tsx"
      via: "Radix DropdownMenu for user menu"
      pattern: "DropdownMenu"
---

<objective>
Rewire header.tsx to use the new DesktopNav and UserAvatar components, replace the hand-rolled dropdown with Radix DropdownMenu containing only Inställningar and Logga ut, and arrange the desktop layout as: Logo | Nav Items | Search | User Dropdown.

Purpose: This is the core restructure that makes key features visible as top-level nav items instead of buried in a dropdown.
Output: Rewritten header.tsx with the new desktop navigation layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-desktop-header-restructure/04-CONTEXT.md
@.planning/phases/04-desktop-header-restructure/04-RESEARCH.md
@.planning/phases/04-desktop-header-restructure/04-01-SUMMARY.md

Key source files:
@apps/frontend/components/header.tsx (current - will be rewritten)
@apps/frontend/components/desktop-nav.tsx (from Plan 01)
@apps/frontend/components/user-avatar.tsx (from Plan 01)
@apps/frontend/components/ui/dropdown-menu.tsx (from Plan 01)
@apps/frontend/components/mobile-menu.tsx (unchanged - reference for mobile sections)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure header.tsx with new desktop nav layout</name>
  <files>apps/frontend/components/header.tsx</files>
  <action>
    Rewrite the desktop sections of header.tsx. Keep the overall structure (sticky header, container, mobile sections) but restructure the desktop layout.

    **Remove:**
    - The hand-rolled dropdown (useState for userMenuOpen, useRef for userMenuRef, useEffect for click-outside, the custom dropdown div with all 7 links)
    - The `User`, `UserCog`, `Settings`, `Home`, `ShoppingCart`, `UtensilsCrossed` icon imports (no longer needed in header - they moved to desktop-nav or are removed)
    - The search bar from the `<nav>` element (keep the search bar but move it to its own section between nav and user dropdown)

    **Add:**
    - Import `DesktopNav` from `./desktop-nav`
    - Import `UserAvatar` from `./user-avatar`
    - Import `DropdownMenu`, `DropdownMenuTrigger`, `DropdownMenuContent`, `DropdownMenuItem` from `./ui/dropdown-menu`

    **New desktop layout inside the h-16 flex container:**

    ```
    <div className="flex h-16 items-center gap-6">
      {/* Logo - flex-shrink-0 */}
      <Link href="/" ...>...</Link>

      {/* Desktop Nav - hidden md:flex */}
      {user && (
        <div className="hidden md:flex items-center">
          <DesktopNav />
        </div>
      )}

      {/* Spacer to push search and user to right */}
      <div className="hidden md:flex flex-1" />

      {/* Desktop Search Bar - hidden md:flex */}
      <div className="hidden md:flex items-center">
        <Suspense fallback={<div className="w-72 h-10 bg-muted rounded-full animate-pulse" />}>
          <SearchBar className="w-72" />
        </Suspense>
      </div>

      {/* Desktop User Dropdown - hidden md:flex */}
      <div className="hidden md:flex items-center">
        {user ? (
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <button className="rounded-full outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2" aria-label="Användarmeny">
                <UserAvatar user={user} />
              </button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end" sideOffset={8}>
              <DropdownMenuItem asChild>
                <Link href="/installningar" className="flex items-center gap-2">
                  <UserCog className="h-4 w-4" />
                  Inställningar
                </Link>
              </DropdownMenuItem>
              <DropdownMenuItem
                onClick={logout}
                className="flex items-center gap-2"
              >
                <LogOut className="h-4 w-4" />
                Logga ut
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        ) : (
          <Button asChild>
            <Link href="/login">Logga in</Link>
          </Button>
        )}
      </div>

      {/* Mobile Menu - unchanged */}
      <MobileMenu />
    </div>
    ```

    **Keep unchanged:**
    - The `<header>` element with sticky positioning and backdrop blur
    - The container wrapper with max-w-7xl
    - The mobile search bar section below the header row (`pb-3 md:hidden`)
    - The MobileMenu dynamic import
    - The Logo section (exact same markup)
    - The logged-out login button

    **Note on dropdown items:** Keep `UserCog` and `LogOut` icon imports (needed for slim dropdown). Remove `User`, `Settings`, `Home`, `ShoppingCart`, `UtensilsCrossed` imports. Keep `Sparkles` import ONLY if still needed (it moved to desktop-nav.tsx, so likely not needed in header anymore). Keep `Menu` and `ChefHat` imports (logo and mobile menu fallback).

    **Note on search bar width:** Reduce from `w-96` to `w-72` since nav items now take horizontal space. The search bar gets fully repositioned in Phase 5, so this is a temporary accommodation.
  </action>
  <verify>
    - `pnpm build` passes (run with `.claude/hooks/run-silent.sh "Build" "pnpm build"`)
    - `pnpm lint` passes (run with `.claude/hooks/run-silent.sh "Lint" "pnpm lint"`)
    - header.tsx imports DesktopNav, UserAvatar, DropdownMenu components
    - header.tsx no longer contains the hand-rolled dropdown (no userMenuOpen state, no userMenuRef, no click-outside useEffect)
    - header.tsx dropdown has exactly 2 items: Inställningar and Logga ut
    - Mobile sections (MobileMenu, mobile search) unchanged
  </verify>
  <done>
    header.tsx uses DesktopNav for top-level nav items and Radix DropdownMenu for a slim user menu with only Inställningar and Logga ut. Layout is Logo | Nav | flex-spacer | Search | User. Mobile unchanged.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Desktop header restructured: 5 key features (Mitt skafferi, Inköpslista, Mitt hem, AI-krediter, Admin) now appear as top-level nav items in the header row. User dropdown slimmed to just Inställningar and Logga ut. User represented by initials circle. AI-krediter shows Sparkles icon with credit count badge.
  </what-built>
  <how-to-verify>
    1. Run `pnpm dev` and open the app in browser at localhost:3000
    2. Log in with a regular (non-admin) account
    3. Verify desktop header (>=768px viewport) shows: Logo | Mitt skafferi, Inköpslista, Mitt hem, [Sparkles icon with badge] | Search bar | [Initials circle]
    4. Verify Admin is NOT visible for non-admin user
    5. Click each nav item - verify underline appears on active item and clears from others
    6. Hover over Sparkles icon - verify tooltip "AI-krediter" appears after ~700ms
    7. Click the initials circle - verify dropdown shows only "Inställningar" and "Logga ut"
    8. Click "Logga ut" - verify it logs out
    9. If possible, log in with admin account and verify "Admin" nav item appears
    10. Resize to mobile (<768px) - verify mobile menu still works unchanged
    11. Verify search bar works on both desktop and mobile
  </how-to-verify>
  <resume-signal>Type "approved" or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Desktop header layout: Logo | Nav Items | Search | User Dropdown
- Nav items visible as top-level links, not in a dropdown
- User dropdown has exactly 2 items (Inställningar, Logga ut)
- Admin only visible to admin users
- Active underline indicator works on navigation
- AI-krediter shows icon with badge and tooltip
- Mobile unchanged
- Build and lint pass
</verification>

<success_criteria>
- Desktop header shows all 5 nav items as top-level links (NAV-01)
- AI-krediter displays as Sparkles icon only with credit badge (NAV-02)
- Admin only visible to admin users (NAV-03)
- Active page has underline indicator (NAV-04)
- User dropdown contains only Inställningar and Logga ut (DROP-01)
- User represented by initials circle
- Mobile drawer and search unchanged
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/04-desktop-header-restructure/04-02-SUMMARY.md`
</output>
