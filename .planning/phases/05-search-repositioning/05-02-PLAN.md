---
phase: 05-search-repositioning
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/frontend/components/ui/popover.tsx
  - apps/frontend/lib/hooks/use-recent-searches.ts
  - apps/frontend/components/search-bar.tsx
autonomous: false

must_haves:
  truths:
    - "Search bar is visually larger (taller input, larger text) in its dedicated row"
    - "Search bar is borderless at rest, border appears on focus"
    - "When search bar is focused and empty, recent searches dropdown appears below"
    - "Recent searches can be individually cleared or all cleared at once"
    - "Search terms are persisted across page refreshes (localStorage)"
  artifacts:
    - path: "apps/frontend/components/ui/popover.tsx"
      provides: "Radix UI Popover primitive wrapper"
      min_lines: 20
    - path: "apps/frontend/lib/hooks/use-recent-searches.ts"
      provides: "useRecentSearches hook with localStorage persistence"
      min_lines: 40
      exports: ["useRecentSearches"]
    - path: "apps/frontend/components/search-bar.tsx"
      provides: "Enhanced search bar with larger styling, recent searches dropdown"
  key_links:
    - from: "apps/frontend/components/search-bar.tsx"
      to: "apps/frontend/lib/hooks/use-recent-searches.ts"
      via: "import useRecentSearches hook"
      pattern: "useRecentSearches"
    - from: "apps/frontend/components/search-bar.tsx"
      to: "apps/frontend/components/ui/popover.tsx"
      via: "import Popover components for dropdown"
      pattern: "Popover"
    - from: "apps/frontend/lib/hooks/use-recent-searches.ts"
      to: "localStorage"
      via: "read/write recent searches"
      pattern: "localStorage"
---

<objective>
Enhance the search bar with larger styling, focus-only border, and a recent searches dropdown panel. Add localStorage persistence for search history.

Purpose: Now that the search bar has a dedicated row (from Plan 01), it should take advantage of the extra space with larger sizing. Recent searches improve search UX by surfacing previous queries.

Output: Popover UI component, useRecentSearches hook, enhanced SearchBar with recent searches dropdown.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-search-repositioning/05-CONTEXT.md
@.planning/phases/05-search-repositioning/05-RESEARCH.md
@.planning/phases/05-search-repositioning/05-01-SUMMARY.md
@apps/frontend/components/search-bar.tsx
@apps/frontend/components/ui/tooltip.tsx
@apps/frontend/components/ui/dropdown-menu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Radix Popover, create Popover UI primitive, useRecentSearches hook</name>
  <files>
    apps/frontend/components/ui/popover.tsx
    apps/frontend/lib/hooks/use-recent-searches.ts
  </files>
  <action>
**Install @radix-ui/react-popover:**
Run: `cd apps/frontend && pnpm add @radix-ui/react-popover`

**Create `apps/frontend/components/ui/popover.tsx`:**
Follow the exact same pattern as `apps/frontend/components/ui/tooltip.tsx` and `apps/frontend/components/ui/dropdown-menu.tsx`:
- "use client" directive
- Import from `@radix-ui/react-popover`
- Re-export: `Popover` (Root), `PopoverTrigger`, `PopoverContent`, `PopoverAnchor`
- `PopoverContent` should be a forwarded ref component wrapping `Radix.PopoverContent` with:
  - `cn()` for className merging
  - Default classes: `z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2`
  - `sideOffset={4}` as default prop
  - Render inside `Radix.PopoverPortal`
- Use `React.ComponentRef<typeof Radix.PopoverContent>` for the ref type (NOT deprecated `React.ElementRef`)
- Match the coding style of existing UI primitives (see tooltip.tsx for reference)

**Create `apps/frontend/lib/hooks/use-recent-searches.ts`:**
- "use client" is NOT needed for a hook file (it will be imported by client components)
- Export `useRecentSearches` hook
- Constants: `STORAGE_KEY = 'matrummet-recent-searches'`, `MAX_SEARCHES = 5`
- State: `const [searches, setSearches] = useState<string[]>([])`
- Load on mount via useEffect (client-side only, avoids hydration mismatch):
  ```
  useEffect(() => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY)
      if (stored) setSearches(JSON.parse(stored))
    } catch { /* silent fail */ }
  }, [])
  ```
- `addSearch(term: string)`: Skip if empty/whitespace. Remove case-insensitive duplicates, prepend term, slice to MAX_SEARCHES, save to localStorage and update state. Wrap in try-catch.
- `removeSearch(term: string)`: Filter out exact match, save and update state. Wrap in try-catch.
- `clearAll()`: Set state to empty array, remove from localStorage. Wrap in try-catch.
- Return `{ searches, addSearch, removeSearch, clearAll }`
- Use `useCallback` for all three functions to prevent unnecessary re-renders
- Import: `{ useState, useEffect, useCallback }` from 'react'
  </action>
  <verify>
Run: `.claude/hooks/run-silent.sh "Build" "pnpm build"` and `.claude/hooks/run-silent.sh "Lint" "pnpm lint"`

Verify:
- @radix-ui/react-popover appears in package.json
- popover.tsx exports Popover, PopoverTrigger, PopoverContent, PopoverAnchor
- use-recent-searches.ts exports useRecentSearches hook
  </verify>
  <done>
- Radix Popover installed and UI primitive created following project conventions
- useRecentSearches hook persists searches in localStorage with 5-item limit
- Build and lint pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance SearchBar with larger styling, focus border, and recent searches dropdown</name>
  <files>
    apps/frontend/components/search-bar.tsx
  </files>
  <action>
Update `apps/frontend/components/search-bar.tsx` with these changes:

**Search bar sizing increase:**
- Change input height from `h-10` to `h-12` (taller input)
- Change text size from `text-sm` to `text-base` (larger text)
- Change search icon size from `h-4 w-4` to `h-5 w-5` (proportionally larger)
- Adjust icon left position if needed for the larger input (left-3.5 is fine for h-12)
- Update clear button sizing proportionally if needed

**Border behavior - borderless at rest, visible on focus:**
- Remove existing border classes: `border border-border/80 shadow-sm`
- Replace with: `border border-transparent` (no visible border at rest)
- Add hover state: `hover:border-border/50` (subtle border appears on hover)
- Keep focus state: `focus:border-primary focus:ring-2 focus:ring-primary/20`
- Add a subtle background at rest for the input to be visible: `bg-muted/50` instead of `bg-white`
- On focus: `focus:bg-white` (transition to white background)

**Recent searches integration:**
- Import `useRecentSearches` from `@/lib/hooks/use-recent-searches`
- Import `Popover, PopoverContent, PopoverTrigger, PopoverAnchor` from `@/components/ui/popover`
- Import `X` icon from lucide-react (already imported), add `Clock` for history icon
- Call `const { searches, addSearch, removeSearch, clearAll } = useRecentSearches()`

**Save searches on submit:**
- In `handleSubmit`: call `addSearch(term)` when term is non-empty (before or after navigation)
- In `handleSearch` (the debounced onChange): do NOT save on every keystroke — only save on submit

**Recent searches dropdown:**
- Compute `const showRecent = isFocused && inputValue === '' && searches.length > 0`
- Wrap the search form in `<Popover open={showRecent}>` (controlled open)
- Use `<PopoverAnchor asChild>` around the existing `<form>` element (this tells Popover where to position the content without needing a trigger click)
- Render `<PopoverContent>` after the form, outside `PopoverAnchor`
- PopoverContent props:
  - `onOpenAutoFocus={(e) => e.preventDefault()}` — keep focus on the input, don't steal it
  - `className="w-[--radix-popover-trigger-width] p-2"` — match the form width
  - `align="start"`
  - `sideOffset={4}`

**Dropdown content (Swedish UI text):**
```
<div className="space-y-1">
  <div className="px-2 py-1.5 text-xs font-medium text-muted-foreground">
    Senaste sökningar
  </div>
  {searches.map((term) => (
    <div key={term} className="flex items-center justify-between gap-2 rounded-sm px-2 py-1.5 hover:bg-muted">
      <button
        type="button"
        onMouseDown={(e) => {
          e.preventDefault() // prevent blur on input
          setInputValue(term)
          // Navigate to search
          startTransition(() => {
            router.push(getSearchUrl(term))
          })
          addSearch(term) // move to top of recent
        }}
        className="flex flex-1 items-center gap-2 text-left text-sm"
      >
        <Clock className="h-3.5 w-3.5 text-muted-foreground" />
        {term}
      </button>
      <button
        type="button"
        onMouseDown={(e) => {
          e.preventDefault() // prevent blur on input
          removeSearch(term)
        }}
        className="rounded-sm p-1 text-muted-foreground hover:text-foreground hover:bg-background"
        aria-label={`Ta bort "${term}"`}
      >
        <X className="h-3 w-3" />
      </button>
    </div>
  ))}
  <div className="border-t border-border mt-1 pt-1">
    <button
      type="button"
      onMouseDown={(e) => {
        e.preventDefault()
        clearAll()
      }}
      className="w-full rounded-sm px-2 py-1.5 text-left text-xs text-muted-foreground hover:text-foreground hover:bg-muted"
    >
      Rensa alla
    </button>
  </div>
</div>
```

**IMPORTANT implementation notes:**
- Use `onMouseDown` with `e.preventDefault()` for dropdown buttons (NOT onClick). This prevents the input from losing focus (blur event) which would close the popover before the click registers.
- The `isFocused` state already exists in search-bar.tsx — reuse it.
- The Popover `open` prop is controlled — no trigger click needed, it opens when conditions are met.
- The `handleSubmit` function should call `addSearch(term)` to save the search term.
- The `handleClear` function does NOT need to add to recent searches (clearing is not a search).
- Keep all existing search functionality intact (debounced navigation, URL sync, scoped search on /alla-recept).
  </action>
  <verify>
Run: `.claude/hooks/run-silent.sh "Build" "pnpm build"` and `.claude/hooks/run-silent.sh "Lint" "pnpm lint"`

Verify:
- SearchBar imports and uses useRecentSearches and Popover components
- Input has h-12 text-base (larger than before)
- Border is transparent at rest, visible on focus
- Build and lint pass
  </verify>
  <done>
- Search bar is visually larger (h-12, text-base, h-5 w-5 icon)
- Search bar is borderless at rest, border appears on focus
- Recent searches dropdown appears when focused and empty
- Recent searches persisted in localStorage
- Individual and bulk clear functionality works
- All existing search behavior preserved
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced search bar with larger styling, focus-only border, and recent searches dropdown with localStorage persistence.</what-built>
  <how-to-verify>
1. Open http://localhost:3000 in desktop browser
2. Observe the search bar — it should be taller and have larger text than before
3. The search bar should have NO visible border at rest (subtle background instead)
4. Click/focus the search bar — a border should appear
5. Type a search query (e.g., "pasta") and press Enter — should navigate to results
6. Clear the search and click the search bar again (focus while empty) — a dropdown should appear showing "Senaste sökningar" with "pasta"
7. Submit another search (e.g., "kyckling") — clear and focus again — both terms should appear (most recent first)
8. Click the X next to one term — it should be removed
9. Click "Rensa alla" — all terms should disappear
10. Refresh the page — focus the search bar — recent searches should still be there (if not all cleared)
11. Test on mobile width: verify search bar styling looks good in the search row
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Search bar is visually larger (h-12 height, text-base font size)
- Border is transparent at rest, appears on focus/hover
- Recent searches dropdown appears when input is focused and empty
- Searches persist across page refreshes (localStorage)
- Individual clear (X button) and bulk clear ("Rensa alla") work
- Clicking a recent search navigates to results
- All existing search functionality preserved (debounced search, URL sync, scoped search)
- Build passes: `pnpm build`
- Lint passes: `pnpm lint`
</verification>

<success_criteria>
Search bar is larger, borderless at rest, shows recent searches on focus, persists search history in localStorage.
</success_criteria>

<output>
After completion, create `.planning/phases/05-search-repositioning/05-02-SUMMARY.md`
</output>
