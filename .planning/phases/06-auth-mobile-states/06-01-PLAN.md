---
phase: 06-auth-mobile-states
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/components/header.tsx
  - apps/frontend/components/mobile-menu.tsx
autonomous: false

must_haves:
  truths:
    - "Logged-out users see Logo + search bar + login/signup buttons (no nav items, no hamburger)"
    - "Login button is outlined (secondary), signup button is filled (primary CTA)"
    - "Mobile logged-in drawer has all nav items with icons and active state indicator"
    - "Mobile drawer has separator before Inställningar and Logga ut"
    - "Mobile drawer nav items match desktop header order"
    - "No hamburger menu or drawer for logged-out users on mobile"
    - "Login/signup buttons visible on mobile for logged-out users"
  artifacts:
    - path: "apps/frontend/components/header.tsx"
      provides: "Auth-conditional header with login/signup buttons for logged-out, skeleton during auth init"
      contains: "Logga in"
    - path: "apps/frontend/components/mobile-menu.tsx"
      provides: "Auth-aware mobile drawer with nav items, icons, active state, separator"
      contains: "usePathname"
  key_links:
    - from: "apps/frontend/components/header.tsx"
      to: "apps/frontend/components/mobile-menu.tsx"
      via: "Conditional render: user ? MobileMenu : login/signup buttons on mobile"
      pattern: "user.*MobileMenu|md:hidden.*Logga in"
    - from: "apps/frontend/components/mobile-menu.tsx"
      to: "apps/frontend/components/desktop-nav.tsx"
      via: "Matching nav item order and icon choices"
      pattern: "Mitt skafferi.*Inköpslista.*Mitt hem.*AI-krediter"
---

<objective>
Implement auth-conditional navigation: logged-out users see minimal header with login/signup buttons, mobile drawer gets proper nav items with icons and active states.

Purpose: Complete the navigation restructure by ensuring all auth states and mobile viewport work correctly — the final phase of the v1.1 milestone.
Output: Updated header.tsx with auth-conditional desktop/mobile sections, and updated mobile-menu.tsx with proper ordering, icons, active state indicators, and separator.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/06-auth-mobile-states/06-CONTEXT.md
@.planning/phases/06-auth-mobile-states/06-RESEARCH.md

# Key source files
@apps/frontend/components/header.tsx
@apps/frontend/components/mobile-menu.tsx
@apps/frontend/components/desktop-nav.tsx
@apps/frontend/components/user-avatar.tsx
@apps/frontend/components/auth-provider.tsx
@apps/frontend/components/ui/button.tsx
@apps/frontend/components/ui/skeleton.tsx
@apps/frontend/components/ui/separator.tsx
@apps/frontend/app/(main)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth-conditional header with login/signup buttons and mobile auth controls</name>
  <files>apps/frontend/components/header.tsx</files>
  <action>
Update header.tsx to handle all auth states:

**Logged-out desktop (hidden md:flex section):**
- Replace the current single "Logga in" button with TWO buttons:
  - "Logga in" with `variant="outline"` linking to `/login` (secondary CTA)
  - "Skapa konto" with default variant (filled, primary CTA) linking to `/registrera`
- Wrap in `flex items-center gap-2`
- Keep the `asChild` pattern with `<Link>` inside `<Button>`

**Logged-out mobile (md:hidden section):**
- Currently `<MobileMenu />` renders unconditionally at the bottom of the header
- Change to conditional: if `user` exists, render `<MobileMenu />`; if not, render login/signup buttons
- Mobile logged-out buttons: use `size="sm"` for compact fit
  - "Logga in" with `variant="outline" size="sm"` asChild wrapping `<Link href="/login">`
  - "Skapa konto" with `size="sm"` (default variant = filled) asChild wrapping `<Link href="/registrera">`
- Wrap in `<div className="md:hidden flex items-center gap-2">`

**Important details:**
- The MobileMenu dynamic import and its loading fallback should ONLY render when user is truthy
- When user is null (logged out), neither the hamburger icon nor the MobileMenu should exist in the DOM
- The desktop "Logga in" button already exists in the `hidden md:flex` section — update it to include "Skapa konto" next to it
- No skeleton needed — the server-side layout provides `initialUser` to AuthProvider, so `user` is immediately available (no FOUC). The layout.tsx already fetches session server-side and passes it as `initialUser`.
  </action>
  <verify>
Run `pnpm build` from repo root — should complete with no errors.
Run `pnpm lint` from repo root — should pass with no warnings.
Visually inspect: grep header.tsx for "Skapa konto" and "Logga in" to confirm both buttons exist.
Grep for "md:hidden" to confirm mobile section has auth-conditional rendering.
  </verify>
  <done>
- Desktop logged-out: Logo + spacer + "Logga in" (outline) + "Skapa konto" (filled) visible
- Desktop logged-in: Logo + DesktopNav + spacer + UserAvatar dropdown (unchanged)
- Mobile logged-out: Logo + spacer + "Logga in" (outline, sm) + "Skapa konto" (filled, sm) visible, no hamburger
- Mobile logged-in: Logo + spacer + hamburger menu icon (unchanged behavior)
- No nav items visible for logged-out users on any viewport
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile drawer with proper nav ordering, icons, active states, and separator</name>
  <files>apps/frontend/components/mobile-menu.tsx</files>
  <action>
Rewrite the logged-in section of mobile-menu.tsx:

**Import additions:**
- Import `usePathname` from `next/navigation`
- Import `Separator` from `@/components/ui/separator`
- Import `cn` from `@/lib/utils`

**Remove logged-out section:**
- The MobileMenu component no longer needs to handle logged-out state (header.tsx handles it now)
- If `!user`, return `null` early (component is only rendered when user exists, but safety guard is good)

**Nav item ordering (must match desktop header):**
1. Mitt skafferi — `UtensilsCrossed` icon — href `/mitt-skafferi`
2. Inköpslista — `ShoppingCart` icon — href `/inkopslista`
3. Mitt hem — `Home` icon — href `/hemmet`
4. AI-krediter — `Sparkles` icon — href `/krediter`
5. Admin (if admin) — `Settings` icon — href `/admin/anvandare`

Then a `<Separator />` divider.

6. Inställningar — `UserCog` icon — href `/installningar`
7. Logga ut — `LogOut` icon — button with `onClick={logout}`

**Remove items that don't belong:**
- Remove "Hem" link (not in desktop nav, not required)
- Remove "Lägg till recept" link (not in desktop nav, not required)

**Active state for each nav item:**
- Use `usePathname()` to detect current page
- For each `<Link>`, apply active styling:
  - Active: `bg-accent text-accent-foreground font-semibold`
  - Inactive: `hover:bg-accent/50`
- Add `aria-current="page"` when active
- Admin item: use `pathname.startsWith('/admin')` for active detection (matches desktop-nav.tsx pattern)
- All other items: exact match `pathname === href`

**Extract a MobileNavItem helper** (inside the file, not exported):
```tsx
function MobileNavItem({ href, icon: Icon, children, isActive, onClick }: {
  href: string
  icon: React.ComponentType<{ className?: string }>
  children: React.ReactNode
  isActive: boolean
  onClick: () => void
}) {
  return (
    <Link
      href={href}
      className={cn(
        'flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors',
        isActive
          ? 'bg-accent text-accent-foreground font-semibold'
          : 'hover:bg-accent/50'
      )}
      aria-current={isActive ? 'page' : undefined}
      onClick={onClick}
    >
      <Icon className="h-4 w-4" />
      {children}
    </Link>
  )
}
```

**Logga ut button:** Style consistently with MobileNavItem but as a `<button>` element, using same gap-3, px-3, py-2, text-sm pattern. Keep `hover:bg-accent/50` only (never "active").

**Close on navigate:** Each nav item `onClick` should call `() => setOpen(false)` (already exists, preserve this).
  </action>
  <verify>
Run `pnpm build` from repo root — should complete with no errors.
Run `pnpm lint` from repo root — should pass with no warnings.
Grep mobile-menu.tsx for "usePathname" to confirm active state detection is in place.
Grep for "Separator" to confirm separator exists between nav items and settings/logout.
Grep for the nav item order: "Mitt skafferi" appears before "Inköpslista" appears before "Mitt hem" appears before "AI-krediter".
Confirm "Hem" and "Lägg till recept" links have been removed.
  </verify>
  <done>
- Mobile drawer nav items in order: Mitt skafferi, Inköpslista, Mitt hem, AI-krediter, Admin (if admin)
- Separator divider between nav items and Inställningar/Logga ut
- All items have icons matching desktop header choices
- Active page highlighted with bg-accent + font-semibold + aria-current="page"
- No "Hem" or "Lägg till recept" items in drawer
- If user is null, component returns null (safety guard)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Auth-conditional navigation for logged-out state (desktop and mobile) and improved mobile drawer with proper ordering, icons, active states, and separator.
  </what-built>
  <how-to-verify>
1. Start dev server: `pnpm dev`
2. Open http://localhost:3000 in a desktop browser

**Logged-out state (desktop):**
3. Log out (or open in incognito)
4. Verify: Header shows Logo on left, "Logga in" (outlined) + "Skapa konto" (filled) on right
5. Verify: No nav items visible (no Mitt skafferi, Inköpslista, etc.)
6. Verify: No hamburger menu icon
7. Verify: Search row appears below header as normal
8. Click "Logga in" — goes to /login
9. Click back, click "Skapa konto" — goes to /registrera

**Logged-out state (mobile):**
10. Resize to mobile width (< 768px) or use Chrome DevTools mobile view
11. Verify: Logo on left, "Logga in" (outline, small) + "Skapa konto" (filled, small) on right
12. Verify: No hamburger icon
13. Both buttons navigate correctly

**Logged-in state (desktop):**
14. Log in
15. Verify: Desktop nav items visible (Mitt skafferi, Inköpslista, Mitt hem, AI-krediter, Admin if admin)
16. Verify: UserAvatar dropdown works (Inställningar, Logga ut)
17. Verify: Everything unchanged from Phase 4/5

**Logged-in state (mobile):**
18. Resize to mobile width
19. Verify: Hamburger icon visible, click to open drawer
20. Verify drawer contents in order: Mitt skafferi, Inköpslista, Mitt hem, AI-krediter, (Admin if admin), then separator, then Inställningar, then Logga ut
21. Verify: Each item has an icon to the left
22. Navigate to a page (e.g., /mitt-skafferi), reopen drawer — verify active item is highlighted
23. Verify: "Hem" and "Lägg till recept" are NOT in the drawer
24. Verify: Logga ut works from drawer
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `pnpm build` passes with no errors
- `pnpm lint` passes with no warnings
- Logged-out desktop: Logo + search row + "Logga in" (outline) + "Skapa konto" (filled), no nav items
- Logged-out mobile: Logo + "Logga in" (sm, outline) + "Skapa konto" (sm, filled), no hamburger
- Logged-in desktop: Unchanged from Phase 4/5
- Logged-in mobile: Drawer has ordered nav items with icons, active state, separator before Inställningar/Logga ut
- No "Hem" or "Lägg till recept" in mobile drawer
</verification>

<success_criteria>
1. Logged-out users on desktop see Logo + "Logga in" (outline) + "Skapa konto" (filled) — no nav items
2. Logged-out users on mobile see Logo + compact login/signup buttons — no hamburger
3. Mobile drawer (logged-in) has all nav items matching desktop order with icons and active state
4. Separator divides nav items from Inställningar + Logga ut in mobile drawer
5. Build and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-auth-mobile-states/06-01-SUMMARY.md`
</output>
