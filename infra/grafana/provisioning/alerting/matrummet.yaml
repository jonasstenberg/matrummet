apiVersion: 1

contactPoints:
  - orgId: 1
    name: matrummet-telegram
    receivers:
      - uid: matrummet-telegram
        type: telegram
        settings:
          bottoken: ${TELEGRAM_BOT_TOKEN}
          chatid: "${TELEGRAM_CHAT_ID}"
          parse_mode: HTML

policies:
  - orgId: 1
    receiver: matrummet-telegram
    group_by:
      - grafana_folder
      - alertname
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h

groups:
  - orgId: 1
    name: matrummet-errors
    folder: Matrummet
    interval: 1m
    rules:
      - uid: matrummet-error-spike
        title: "Matrummet: error spike"
        condition: threshold
        for: 0s
        annotations:
          summary: "More than 3 errors in 5 minutes across Matrummet services"
        labels:
          severity: critical
        data:
          - refId: errors
            datasourceUid: loki
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: 'sum(count_over_time({unit=~"matrummet.*"} | json | level = `error` [5m]))'
              refId: errors
          - refId: threshold
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              type: threshold
              expression: errors
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 3
              refId: threshold
        noDataState: OK
        execErrState: Alerting

      - uid: matrummet-app-down
        title: "Matrummet: app not logging"
        condition: threshold
        for: 10m
        annotations:
          summary: "No logs from matrummet.service for 10 minutes â€” app may be down"
        labels:
          severity: critical
        data:
          - refId: logs
            datasourceUid: loki
            relativeTimeRange:
              from: 600
              to: 0
            model:
              expr: 'count_over_time({unit="matrummet.service"} [10m])'
              refId: logs
          - refId: threshold
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              type: threshold
              expression: logs
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 1
              refId: threshold
        noDataState: Alerting
        execErrState: Alerting
